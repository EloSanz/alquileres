name: Backend CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: penta mont
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
    - name: Verify SSH credentials exist
      run: |
        if [ -z "${{ secrets.SSH_HOST }}" ]; then 
          echo "‚ùå SSH_HOST no est√° configurado en el environment 'penta mont'"
          echo "Por favor, configura SSH_HOST en: Settings > Environments > penta mont > Secrets"
          echo ""
          echo "El valor debe ser:"
          echo "  - Una IP v√°lida (ej: 123.45.67.89)"
          echo "  - Un hostname v√°lido (ej: vps.tu-dominio.com)"
          echo "  - Sin espacios ni caracteres especiales"
          echo "  - Sin http:// o https://"
          exit 1
        fi
        if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then 
          echo "‚ùå SSH_PASSWORD no est√° configurado en el environment 'penta mont'"
          echo "Por favor, configura SSH_PASSWORD en: Settings > Environments > penta mont > Secrets"
          exit 1
        fi
        
        # Verificar formato b√°sico del host (sin mostrar el valor completo)
        HOST="${{ secrets.SSH_HOST }}"
        HOST_LENGTH=${#HOST}
        echo "‚úî SSH_HOST est√° configurado (longitud: $HOST_LENGTH caracteres)"
        echo "‚úî SSH_PASSWORD est√° configurado"
        
        # Verificar que no tenga espacios
        if [[ "$HOST" =~ [[:space:]] ]]; then
          echo "‚ùå ERROR: SSH_HOST contiene espacios. Esto causar√° el error 'no such host'"
          echo "Por favor, verifica que el valor no tenga espacios al inicio o final"
          exit 1
        fi
        
        # Verificar que no empiece con http
        if [[ "$HOST" =~ ^https?:// ]]; then
          echo "‚ùå ERROR: SSH_HOST no debe incluir http:// o https://"
          echo "Usa solo la IP o hostname (ej: 123.45.67.89 o vps.tu-dominio.com)"
          exit 1
        fi
        
        echo "‚úî Formato de SSH_HOST parece correcto"
        echo "‚úî Credenciales SSH verificadas"
    
    - name: Test DNS resolution
      run: |
        # Intentar resolver el hostname para diagnosticar problemas de DNS
        HOST="${{ secrets.SSH_HOST }}"
        echo "üîç Intentando resolver el host..."
        echo "Host (primeros 3 caracteres): ${HOST:0:3}..."
        
        # Verificar si es una IP
        if [[ "$HOST" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
          echo "‚úî Parece ser una IP v√°lida"
        else
          echo "‚ÑπÔ∏è  Parece ser un hostname, intentando resolver DNS..."
          if command -v nslookup &> /dev/null; then
            if nslookup "$HOST" 2>&1 | head -5; then
              echo "‚úî DNS resolution exitosa"
            else
              echo "‚ö†Ô∏è  nslookup fall√≥ - el hostname podr√≠a no existir"
            fi
          fi
          if command -v dig &> /dev/null; then
            RESULT=$(dig "$HOST" +short 2>&1)
            if [ -n "$RESULT" ]; then
              echo "‚úî dig resolution exitosa"
            else
              echo "‚ö†Ô∏è  dig fall√≥ - el hostname podr√≠a no existir"
            fi
          fi
        fi
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: root
        password: ${{ secrets.SSH_PASSWORD }}
        port: 22
        timeout: 60s
        command_timeout: 10m
        script: |
          echo "‚û°Ô∏è Actualizando proyecto en VPS..."
          cd /var/www/alquileres-app || exit 1
          git fetch origin develop && git reset --hard origin/develop
          git clean -fd

          echo "‚û°Ô∏è Configurando PATH..."
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

          echo "‚û°Ô∏è Instalando dependencias del backend..."
          cd /var/www/alquileres-app/server
          npm install

          echo "‚û°Ô∏è Aplicando migraciones y generando cliente Prisma..."
          npx prisma migrate deploy
          npx prisma generate

          echo "‚û°Ô∏è Construyendo backend..."
          npm run build

          echo "‚û°Ô∏è Instalando dependencias del frontend..."
          cd /var/www/alquileres-app/web
          npm install

          echo "‚û°Ô∏è Construyendo frontend..."
          npm run build

          echo "‚û°Ô∏è Configurando Nginx..."
          cd /var/www/alquileres-app
          
          # Verificar si Nginx est√° instalado
          if ! command -v nginx &> /dev/null; then
            echo "‚ö†Ô∏è  Nginx no est√° instalado. Instalando..."
            apt-get update -qq
            apt-get install -y nginx
          fi
          
          # Deshabilitar configuraci√≥n por defecto si existe
          if [ -L /etc/nginx/sites-enabled/default ]; then
            rm /etc/nginx/sites-enabled/default
            echo "‚úÖ Configuraci√≥n por defecto de Nginx deshabilitada"
          fi
          
          # Determinar qu√© configuraci√≥n usar
          # Verificar si el frontend est√° construido (producci√≥n) o necesita proxy (desarrollo)
          if [ -d "web/dist" ] && [ "$(ls -A web/dist 2>/dev/null)" ]; then
            echo "‚úÖ Frontend construido detectado. Usando configuraci√≥n de producci√≥n..."
            USE_PRODUCTION=true
          else
            echo "‚ÑπÔ∏è  Frontend no construido. Usando configuraci√≥n de desarrollo (proxy a Vite)..."
            USE_PRODUCTION=false
          fi
          
          # Buscar cualquier certificado SSL disponible
          SSL_CERT_DIR=$(find /etc/letsencrypt/live -mindepth 1 -maxdepth 1 -type d 2>/dev/null | head -1)
          if [ -n "$SSL_CERT_DIR" ] && [ -d "$SSL_CERT_DIR" ]; then
            echo "‚úÖ Certificado SSL encontrado en $SSL_CERT_DIR. Usando configuraci√≥n HTTPS..."
            if [ "$USE_PRODUCTION" = true ]; then
              CONFIG_FILE="nginx/alquileres-app.conf.https"
            else
              CONFIG_FILE="nginx/alquileres-app.conf.https.development"
            fi
            # Actualizar el archivo de configuraci√≥n con la ruta correcta del certificado
            DOMAIN_NAME=$(basename "$SSL_CERT_DIR")
            sed -i "s|/etc/letsencrypt/live/icards.fun|/etc/letsencrypt/live/$DOMAIN_NAME|g" "$CONFIG_FILE" 2>/dev/null || true
          else
            echo "‚ÑπÔ∏è  No hay certificado SSL. Usando configuraci√≥n HTTP..."
            if [ "$USE_PRODUCTION" = true ]; then
              CONFIG_FILE="nginx/alquileres-app.conf.http.production"
            else
              CONFIG_FILE="nginx/alquileres-app.conf.http"
            fi
          fi
          
          # Copiar configuraci√≥n de Nginx si existe
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" /etc/nginx/sites-available/alquileres-app.conf
            
            # Crear enlace simb√≥lico si no existe
            if [ ! -L /etc/nginx/sites-enabled/alquileres-app.conf ]; then
              ln -s /etc/nginx/sites-available/alquileres-app.conf /etc/nginx/sites-enabled/alquileres-app.conf
              echo "‚úÖ Configuraci√≥n de Nginx habilitada"
            fi
            
            # Verificar y recargar Nginx
            if nginx -t; then
              echo "‚úÖ Configuraci√≥n de Nginx v√°lida"
              systemctl reload nginx
              echo "‚úÖ Nginx recargado"
            else
              echo "‚ùå Error en la configuraci√≥n de Nginx"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  Archivo de configuraci√≥n de Nginx no encontrado. Saltando configuraci√≥n..."
          fi
          
          # Asegurar que Nginx est√© habilitado para iniciar al arrancar
          systemctl enable nginx

          echo "‚û°Ô∏è Iniciando servicios Backend y Frontend con Screen..."
          chmod +x start_services_screen.sh
          ./start_services_screen.sh
          echo "‚úÖ Servicios levantados con Screen"

