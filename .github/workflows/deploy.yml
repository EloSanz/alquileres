name: Backend CI

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: hostinger
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
    - name: Verify SSH credentials exist
      run: |
        if [ -z "${{ secrets.SSH_HOST }}" ]; then echo "âŒ SSH_HOST no estÃ¡ configurado"; exit 1; fi
        if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then echo "âŒ SSH_PASSWORD no estÃ¡ configurado"; exit 1; fi
        echo "âœ” Credenciales SSH verificadas"

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: root
        password: ${{ secrets.SSH_PASSWORD }}
        port: 22
        timeout: 30s
        script: |
          set -e

          echo "âž¡ï¸ Actualizando proyecto en VPS..."
          echo "ðŸ“‚ Cambiando al directorio del proyecto..."
          cd /root/alquileres-app || exit 1
          pwd && ls -la

          echo "ðŸ“¥ Obteniendo cambios desde Git..."
          git fetch origin develop
          
          # Verificar si hay cambios locales
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš ï¸  ADVERTENCIA: Hay cambios locales sin commitear"
            git status
            echo "ðŸ”„ Guardando cambios locales en stash..."
            git stash push -m "Stash antes de deploy $(date +%Y-%m-%d_%H:%M:%S)"
          fi
          
          # Verificar si la rama local estÃ¡ detrÃ¡s de origin/develop
          LOCAL=$(git rev-parse @)
          REMOTE=$(git rev-parse origin/develop)
          
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "ðŸ”„ Actualizando cÃ³digo desde origin/develop..."
            # Intentar hacer pull primero (mÃ¡s seguro)
            if git pull origin develop --no-edit; then
              echo "âœ… Pull exitoso"
            else
              echo "âš ï¸  Pull fallÃ³, haciendo reset --hard..."
              git reset --hard origin/develop
              git clean -fd
            fi
          else
            echo "âœ… El cÃ³digo local ya estÃ¡ actualizado con origin/develop"
          fi

          echo "ðŸ“‹ Estado actual del repositorio:"
          git log --oneline -5
          git status

          echo "âž¡ï¸ Reiniciando servicios..."

          # FunciÃ³n para verificar si un servicio estÃ¡ corriendo
          check_service() {
            local port=$1
            local name=$2
            if curl -f -s --max-time 5 http://localhost:$port > /dev/null 2>&1; then
              echo "âœ… $name corriendo en puerto $port"
              return 0
            else
              echo "âŒ $name NO responde en puerto $port"
              return 1
            fi
          }

          if command -v pm2 &> /dev/null; then
            echo "ðŸ”§ PM2 detectado, usando configuraciÃ³n de PM2..."
            if [ -f ecosystem.config.js ]; then
              echo "ðŸ“„ Encontrado ecosystem.config.js"
              pm2 describe alquileres-backend > /dev/null 2>&1 && pm2 restart alquileres-backend || pm2 start ecosystem.config.js
              pm2 describe alquileres-frontend > /dev/null 2>&1 && pm2 restart alquileres-frontend || pm2 start ecosystem.config.js

              echo "ðŸ“Š Estado de procesos PM2:"
              pm2 list

              sleep 5
              check_service 4000 "Backend API"
              check_service 4001 "Frontend"
            else
              echo "âš ï¸  No se encontrÃ³ ecosystem.config.js, usando script alternativo..."
              chmod +x start_services_screen.sh
              ./start_services_screen.sh
            fi
          else
            echo "âš ï¸  PM2 no estÃ¡ instalado, usando script alternativo..."
            chmod +x start_services_screen.sh
            ./start_services_screen.sh
          fi

          echo "ðŸ” VerificaciÃ³n final de servicios:"
          check_service 4000 "Backend API"
          check_service 4001 "Frontend"

          echo "ðŸ“ Logs recientes:"
          if command -v pm2 &> /dev/null; then
            pm2 logs --lines 10 --nostream || true
          fi

          echo "âœ… Deploy finalizado"
