name: Backend CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: penta mont
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
    - name: Verify SSH credentials exist
      run: |
        if [ -z "${{ secrets.SSH_HOST }}" ]; then 
          echo "‚ùå SSH_HOST no est√° configurado en el environment 'penta mont'"
          echo "Por favor, configura SSH_HOST en: Settings > Environments > penta mont > Secrets"
          echo ""
          echo "El valor debe ser:"
          echo "  - Una IP v√°lida (ej: 123.45.67.89)"
          echo "  - Un hostname v√°lido (ej: vps.tu-dominio.com)"
          echo "  - Sin espacios ni caracteres especiales"
          echo "  - Sin http:// o https://"
          exit 1
        fi
        if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then 
          echo "‚ùå SSH_PASSWORD no est√° configurado en el environment 'penta mont'"
          echo "Por favor, configura SSH_PASSWORD en: Settings > Environments > penta mont > Secrets"
          exit 1
        fi
        
        # Verificar formato b√°sico del host (sin mostrar el valor completo)
        HOST="${{ secrets.SSH_HOST }}"
        HOST_LENGTH=${#HOST}
        echo "‚úî SSH_HOST est√° configurado (longitud: $HOST_LENGTH caracteres)"
        echo "‚úî SSH_PASSWORD est√° configurado"
        
        # Limpiar espacios al inicio y final
        HOST_TRIMMED=$(echo "$HOST" | xargs)
        HOST_TRIMMED_LENGTH=${#HOST_TRIMMED}
        
        # Verificar que no tenga espacios
        if [[ "$HOST" =~ [[:space:]] ]]; then
          echo "‚ö†Ô∏è  ADVERTENCIA: SSH_HOST contiene espacios"
          echo "   Longitud original: $HOST_LENGTH caracteres"
          echo "   Longitud sin espacios: $HOST_TRIMMED_LENGTH caracteres"
          echo ""
          echo "üîß Soluci√≥n:"
          echo "   1. Ve a: Settings > Environments > 'penta mont' > Secrets"
          echo "   2. Edita SSH_HOST"
          echo "   3. Elimina TODOS los espacios (inicio, final, y en medio)"
          echo "   4. El valor debe ser solo: IP o hostname"
          echo "      Ejemplo correcto: 123.45.67.89"
          echo "      Ejemplo correcto: vps.tu-dominio.com"
          echo ""
          echo "   Si el valor tiene espacios en medio, probablemente copiaste mal."
          echo "   Copia solo la IP o hostname, sin espacios."
          exit 1
        fi
        
        # Verificar que no empiece con http
        if [[ "$HOST" =~ ^https?:// ]]; then
          echo "‚ùå ERROR: SSH_HOST no debe incluir http:// o https://"
          echo "Usa solo la IP o hostname (ej: 123.45.67.89 o vps.tu-dominio.com)"
          exit 1
        fi
        
        echo "‚úî Formato de SSH_HOST parece correcto"
        echo "‚úî Credenciales SSH verificadas"
    
    - name: Test DNS resolution
      run: |
        # Intentar resolver el hostname para diagnosticar problemas de DNS
        HOST="${{ secrets.SSH_HOST }}"
        echo "üîç Diagnosticando SSH_HOST..."
        echo "Longitud del host: ${#HOST} caracteres"
        
        # Mostrar caracteres especiales sin exponer el valor completo
        echo "Primer car√°cter: '${HOST:0:1}'"
        echo "√öltimo car√°cter: '${HOST: -1}'"
        
        # Verificar caracteres no v√°lidos
        if [[ "$HOST" =~ [^a-zA-Z0-9\.\-] ]]; then
          echo "‚ö†Ô∏è  ADVERTENCIA: El host contiene caracteres especiales que podr√≠an causar problemas"
          echo "Caracteres permitidos: letras, n√∫meros, puntos (.) y guiones (-)"
        fi
        
        # Verificar si es una IP
        if [[ "$HOST" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
          echo "‚úî Formato: IP v√°lida"
          echo "Probando conectividad..."
          if timeout 5 ping -c 1 "$HOST" &> /dev/null; then
            echo "‚úî La IP responde a ping"
          else
            echo "‚ö†Ô∏è  La IP no responde a ping (puede estar bloqueado por firewall)"
          fi
        else
          echo "‚ÑπÔ∏è  Formato: Hostname"
          echo "Intentando resolver DNS..."
          if command -v nslookup &> /dev/null; then
            if nslookup "$HOST" 2>&1 | head -5; then
              echo "‚úî DNS resolution exitosa con nslookup"
            else
              echo "‚ùå nslookup fall√≥ - el hostname no se puede resolver"
              echo "Esto causar√° el error 'no such host'"
            fi
          fi
          if command -v dig &> /dev/null; then
            RESULT=$(dig "$HOST" +short 2>&1)
            if [ -n "$RESULT" ] && [[ ! "$RESULT" =~ "connection timed out" ]]; then
              echo "‚úî DNS resolution exitosa con dig: $RESULT"
            else
              echo "‚ùå dig fall√≥ - el hostname no se puede resolver"
            fi
          fi
        fi
        
        echo ""
        echo "üí° Si ves errores arriba, verifica:"
        echo "   1. El valor de SSH_HOST en GitHub (Settings > Environments > penta mont > Secrets)"
        echo "   2. Que no tenga espacios al inicio o final"
        echo "   3. Que sea una IP v√°lida (ej: 123.45.67.89) o hostname v√°lido"
        echo "   4. Si es hostname, que el DNS est√© configurado correctamente"
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: root
        password: ${{ secrets.SSH_PASSWORD }}
        port: 22
        timeout: 60s
        command_timeout: 10m
        script: |
          echo "‚û°Ô∏è Actualizando proyecto en VPS..."
          cd /var/www/alquileres-app || exit 1
          git fetch origin develop && git reset --hard origin/develop
          git clean -fd

          echo "‚û°Ô∏è Configurando PATH..."
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

          echo "‚û°Ô∏è Instalando dependencias del backend..."
          cd /var/www/alquileres-app/server
          npm install

          echo "‚û°Ô∏è Aplicando migraciones y generando cliente Prisma..."
          npx prisma migrate deploy
          npx prisma generate

          echo "‚û°Ô∏è Construyendo backend..."
          npm run build

          echo "‚û°Ô∏è Instalando dependencias del frontend..."
          cd /var/www/alquileres-app/web
          npm install

          echo "‚û°Ô∏è Construyendo frontend..."
          npm run build

          echo "‚û°Ô∏è Configurando Nginx..."
          cd /var/www/alquileres-app
          
          # Verificar si Nginx est√° instalado
          if ! command -v nginx &> /dev/null; then
            echo "‚ö†Ô∏è  Nginx no est√° instalado. Instalando..."
            apt-get update -qq
            apt-get install -y nginx
          fi
          
          # Deshabilitar configuraci√≥n por defecto si existe
          if [ -L /etc/nginx/sites-enabled/default ]; then
            rm /etc/nginx/sites-enabled/default
            echo "‚úÖ Configuraci√≥n por defecto de Nginx deshabilitada"
          fi
          
          # Determinar qu√© configuraci√≥n usar
          # Verificar si el frontend est√° construido (producci√≥n) o necesita proxy (desarrollo)
          if [ -d "web/dist" ] && [ "$(ls -A web/dist 2>/dev/null)" ]; then
            echo "‚úÖ Frontend construido detectado. Usando configuraci√≥n de producci√≥n..."
            USE_PRODUCTION=true
          else
            echo "‚ÑπÔ∏è  Frontend no construido. Usando configuraci√≥n de desarrollo (proxy a Vite)..."
            USE_PRODUCTION=false
          fi
          
          # Buscar cualquier certificado SSL disponible
          SSL_CERT_DIR=$(find /etc/letsencrypt/live -mindepth 1 -maxdepth 1 -type d 2>/dev/null | head -1)
          if [ -n "$SSL_CERT_DIR" ] && [ -d "$SSL_CERT_DIR" ]; then
            echo "‚úÖ Certificado SSL encontrado en $SSL_CERT_DIR. Usando configuraci√≥n HTTPS..."
            if [ "$USE_PRODUCTION" = true ]; then
              CONFIG_FILE="nginx/alquileres-app.conf.https"
            else
              CONFIG_FILE="nginx/alquileres-app.conf.https.development"
            fi
            # Actualizar el archivo de configuraci√≥n con la ruta correcta del certificado
            DOMAIN_NAME=$(basename "$SSL_CERT_DIR")
            sed -i "s|/etc/letsencrypt/live/icards.fun|/etc/letsencrypt/live/$DOMAIN_NAME|g" "$CONFIG_FILE" 2>/dev/null || true
          else
            echo "‚ÑπÔ∏è  No hay certificado SSL. Usando configuraci√≥n HTTP..."
            if [ "$USE_PRODUCTION" = true ]; then
              CONFIG_FILE="nginx/alquileres-app.conf.http.production"
            else
              CONFIG_FILE="nginx/alquileres-app.conf.http"
            fi
          fi
          
          # Copiar configuraci√≥n de Nginx si existe
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" /etc/nginx/sites-available/alquileres-app.conf
            
            # Crear enlace simb√≥lico si no existe
            if [ ! -L /etc/nginx/sites-enabled/alquileres-app.conf ]; then
              ln -s /etc/nginx/sites-available/alquileres-app.conf /etc/nginx/sites-enabled/alquileres-app.conf
              echo "‚úÖ Configuraci√≥n de Nginx habilitada"
            fi
            
            # Verificar y recargar Nginx
            if nginx -t; then
              echo "‚úÖ Configuraci√≥n de Nginx v√°lida"
              systemctl reload nginx
              echo "‚úÖ Nginx recargado"
            else
              echo "‚ùå Error en la configuraci√≥n de Nginx"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  Archivo de configuraci√≥n de Nginx no encontrado. Saltando configuraci√≥n..."
          fi
          
          # Asegurar que Nginx est√© habilitado para iniciar al arrancar
          systemctl enable nginx

          echo "‚û°Ô∏è Iniciando servicios Backend y Frontend con Screen..."
          chmod +x start_services_screen.sh
          ./start_services_screen.sh
          echo "‚úÖ Servicios levantados con Screen"

